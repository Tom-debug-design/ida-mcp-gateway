name: IDA AutoRun (Gateway)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # hver time (UTC). Safe mode.

concurrency:
  group: ida-autorun
  cancel-in-progress: false

jobs:
  ida:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gateway repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openai requests

      - name: Run Job Generator
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          MAX_JOBS_PER_RUN: "1"
          JOB_GENERATE_INTERVAL_MIN: "60"
        run: |
          python worker/job_generator.py

      - name: Run Job Runner
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          MAX_JOBS_PER_RUN: "1"
        run: |
          python worker/job_runner.py

      - name: Publish results to target repos (atomicbot-agent + PureBloomWorld-site)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          TARGET_REPOS: "Tom-debug-design/atomicbot-agent,Tom-debug-design/PureBloomWorld-site"
        run: |
          python worker/publish_results.py

      - name: Commit gateway outputs (logs/state)
        run: |
          git config user.name "ida-gateway-bot"
          git config user.email "ida-gateway-bot@users.noreply.github.com"
          git add -A
          git commit -m "IDA: run + logs + state" || echo "No changes"
          git push
