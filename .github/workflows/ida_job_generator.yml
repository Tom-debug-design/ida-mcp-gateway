name: IDA Job Generator (A1)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

concurrency:
  group: ida-job-generator
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: A1 Guardrails (safe)
  shell: bash
  run: |
    set -e

    mkdir -p agent_outbox ops/logs ops/flags

    if [ -f "ops/flags/STOP_AUTOPILOT" ]; then
      echo "STOP_AUTOPILOT present – exiting"
      exit 0
    fi

    # SAFE count (never fails if empty)
    PENDING=$(find agent_outbox -maxdepth 1 -type f -name "*.json" | wc -l | tr -d ' ')

    echo "Pending jobs: $PENDING"

    if [ "$PENDING" -ge 3 ]; then
      echo "Backlog cap reached – skipping generation"
      exit 0
    fi


          # Count pending jobs SAFELY
          PENDING=$(find agent_outbox -maxdepth 1 -name "*.json" | wc -l | tr -d ' ')

          echo "Pending jobs: $PENDING"

          if [ "$PENDING" -ge 3 ]; then
            echo "Backlog cap reached – skipping generation"
            exit 0
          fi

      - name: Generate job JSON
        shell: bash
        run: |
          TS=$(date -u +"%Y%m%d-%H%M%S")
          JOB="agent_outbox/job-autogen-$TS.json"

          cat > "$JOB" <<EOF
          {
            "task": "ROI_SCAN",
            "priority": "normal",
            "created_utc": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "rules": [
              "ROI only",
              "Concrete repo actions only",
              "No ideas, no theory"
            ]
          }
          EOF

          echo "Generated $JOB"

      - name: Commit job (safe)
        shell: bash
        run: |
          git config user.name "ida-outbox-bot"
          git config user.email "ida@bot.local"

          git add agent_outbox/*.json
          git commit -m "IDA A1: generate job" || exit 0
          git pull --rebase
          git push
